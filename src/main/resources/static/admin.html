<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBite - Panel Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --primary:#ff6b35;
            --secondary:#0f172a;
            --bg:#f4f6f9;
            --white:#ffffff;
            --gray:#6b7280;
            --border:#e5e7eb;
            --success:#06d6a0;
            --danger:#ef476f;
            --shadow:0 10px 25px rgba(0,0,0,0.08);
        }

        *{margin:0;padding:0;box-sizing:border-box;}

        body{
            font-family:'Outfit',sans-serif;
            background:var(--bg);
            color:var(--secondary);
        }

        .navbar{
            background:var(--secondary);
            color:white;
            padding:1rem 1.5rem;
            position:sticky;
            top:0;
            z-index:100;
            box-shadow:var(--shadow);
        }

        .nav-container{
            max-width:1400px;
            margin:0 auto;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .brand{
            font-size:1.8rem;
            font-weight:700;
        }

        .nav-right{
            display:flex;
            gap:1rem;
            align-items:center;
        }

        .username{
            font-weight:600;
        }

        .btn-logout{
            background:rgba(255,255,255,.15);
            border:1px solid white;
            color:white;
            padding:.6rem 1.2rem;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
            transition:.2s;
        }

        .btn-logout:hover{
            background:white;
            color:var(--secondary);
        }

        .container{
            max-width:1400px;
            margin:0 auto;
            padding:2rem 1.5rem;
        }

        .header{
            margin-bottom:2rem;
        }

        .title{
            font-size:2rem;
            font-weight:700;
            margin-bottom:.5rem;
        }

        .subtitle{
            color:var(--gray);
        }

        .stats{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
            gap:1.5rem;
            margin-bottom:2rem;
        }

        .stat-card{
            background:white;
            border:1px solid var(--border);
            border-radius:12px;
            padding:1.5rem;
            transition:.2s;
        }

        .stat-card:hover{
            box-shadow:var(--shadow);
            transform:translateY(-2px);
        }

        .stat-value{
            font-size:2.5rem;
            font-weight:700;
            color:var(--primary);
            margin-bottom:.3rem;
        }

        .stat-label{
            color:var(--gray);
            font-weight:600;
        }

        .tabs{
            display:flex;
            gap:.8rem;
            margin-bottom:2rem;
            flex-wrap:wrap;
        }

        .tab-btn{
            padding:.8rem 1.5rem;
            border:1px solid var(--border);
            background:white;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
            transition:.2s;
        }

        .tab-btn:hover{
            border-color:var(--primary);
            color:var(--primary);
        }

        .tab-btn.active{
            background:var(--primary);
            color:white;
            border-color:var(--primary);
        }

        .tab-content{
            display:none;
        }

        .tab-content.active{
            display:block;
        }

        .card{
            background:white;
            border:1px solid var(--border);
            border-radius:12px;
            padding:1.5rem;
            margin-bottom:1.5rem;
        }

        .card-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:1.5rem;
            padding-bottom:1rem;
            border-bottom:1px solid var(--border);
        }

        .card-title{
            font-size:1.3rem;
            font-weight:700;
        }

        .btn{
            padding:.7rem 1.2rem;
            border:none;
            border-radius:8px;
            font-weight:600;
            cursor:pointer;
            font-size:.9rem;
            transition:.2s;
        }

        .btn-primary{background:var(--primary);color:white;}
        .btn-primary:hover{background:#e85b2a;}
        .btn-success{background:var(--success);color:white;}
        .btn-success:hover{background:#05c496;}
        .btn-danger{background:var(--danger);color:white;}
        .btn-danger:hover{background:#e03060;}
        .btn-secondary{background:var(--secondary);color:white;}
        .btn-secondary:hover{background:#1e293b;}

        .filters{
            display:flex;
            gap:.8rem;
            margin-bottom:1.5rem;
            flex-wrap:wrap;
        }

        .filter-select{
            padding:.7rem 1rem;
            border:1px solid var(--border);
            border-radius:8px;
            font-size:.9rem;
            min-width:150px;
        }

        table{
            width:100%;
            border-collapse:collapse;
        }

        th{
            background:var(--bg);
            padding:1rem;
            text-align:left;
            font-weight:700;
            border-bottom:2px solid var(--border);
        }

        td{
            padding:1rem;
            border-bottom:1px solid var(--border);
        }

        tr:hover{
            background:var(--bg);
        }

        .badge{
            display:inline-block;
            padding:.3rem .8rem;
            border-radius:6px;
            font-size:.85rem;
            font-weight:600;
        }

        .badge-success{background:#d1fae5;color:#065f46;}
        .badge-danger{background:#fee2e2;color:#991b1b;}
        .badge-warning{background:#fef3c7;color:#92400e;}
        .badge-info{background:#dbeafe;color:#1e40af;}

        .actions{
            display:flex;
            gap:.5rem;
            flex-wrap:wrap;
        }

        .modal{
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,.5);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:1000;
        }

        .modal.show{
            display:flex;
        }

        .modal-content{
            background:white;
            border-radius:12px;
            width:90%;
            max-width:600px;
            max-height:90vh;
            overflow-y:auto;
        }

        .modal-header{
            padding:1.5rem;
            border-bottom:1px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .modal-title{
            font-size:1.5rem;
            font-weight:700;
        }

        .close{
            background:none;
            border:none;
            font-size:1.5rem;
            cursor:pointer;
            color:var(--gray);
        }

        .modal-body{
            padding:1.5rem;
        }

        .form-group{
            margin-bottom:1.2rem;
        }

        .form-label{
            display:block;
            font-weight:600;
            margin-bottom:.5rem;
            font-size:.9rem;
        }

        .form-control{
            width:100%;
            padding:.8rem 1rem;
            border:1px solid var(--border);
            border-radius:8px;
            font-size:.95rem;
        }

        .form-control:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(255,107,53,.15);
        }

        textarea.form-control{
            resize:vertical;
            min-height:100px;
        }

        .form-row{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:1rem;
        }

        .alert{
            padding:.9rem 1rem;
            border-radius:8px;
            margin-bottom:1rem;
            display:none;
        }

        .alert.show{
            display:block;
        }

        .alert-success{
            background:#d1fae5;
            color:#065f46;
        }

        .alert-error{
            background:#fee2e2;
            color:#991b1b;
        }

        .loader{
            text-align:center;
            padding:2rem;
            color:var(--gray);
        }

        .hidden{
            display:none !important;
        }

        .empty{
            text-align:center;
            padding:3rem;
            color:var(--gray);
        }

        .modal-actions{
            display:flex;
            gap:1rem;
            justify-content:flex-end;
            margin-top:1.5rem;
        }

        @media(max-width:768px){
            .form-row{
                grid-template-columns:1fr;
            }
            .stats{
                grid-template-columns:1fr;
            }
            .actions{
                flex-direction:column;
            }
            .actions .btn{
                width:100%;
            }
        }
    </style>
</head>

<body>

<div class="navbar">
    <div class="nav-container">
        <div class="brand">üçî QuickBite Admin</div>
        <div class="nav-right">
            <span class="username" id="adminUsername"></span>
            <button class="btn-logout" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div class="title">Panel de Administraci√≥n</div>
        <div class="subtitle">Gestiona tu plataforma de delivery</div>
    </div>

    <!-- ESTAD√çSTICAS -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="stat-restaurantes">0</div>
            <div class="stat-label">Restaurantes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-productos">0</div>
            <div class="stat-label">Productos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-pedidos">0</div>
            <div class="stat-label">Pedidos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-clientes">0</div>
            <div class="stat-label">Clientes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-repartidores">0</div>
            <div class="stat-label">Repartidores</div>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('restaurantes')">Restaurantes</button>
        <button class="tab-btn" onclick="switchTab('productos')">Productos</button>
        <button class="tab-btn" onclick="switchTab('pedidos')">Pedidos</button>
        <button class="tab-btn" onclick="switchTab('clientes')">Clientes</button>
        <button class="tab-btn" onclick="switchTab('repartidores')">Repartidores</button>
    </div>

    <!-- TAB: RESTAURANTES -->
    <div id="tab-restaurantes" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Restaurantes</div>
                <button class="btn btn-primary" onclick="openRestauranteModal()">+ Nuevo Restaurante</button>
            </div>
            <div id="loader-restaurantes" class="loader">Cargando...</div>
            <table id="table-restaurantes" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Direcci√≥n</th>
                    <th>Tel√©fono</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-restaurantes"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: PRODUCTOS -->
    <div id="tab-productos" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Productos</div>
                <button class="btn btn-primary" onclick="openProductoModal()">+ Nuevo Producto</button>
            </div>
            <div class="filters">
                <select class="filter-select" id="filter-restaurante" onchange="loadProductos()">
                    <option value="">Todos los restaurantes</option>
                </select>
                <select class="filter-select" id="filter-disponible" onchange="loadProductos()">
                    <option value="">Todos los estados</option>
                    <option value="true">Disponibles</option>
                    <option value="false">No disponibles</option>
                </select>
            </div>
            <div id="loader-productos" class="loader">Cargando...</div>
            <table id="table-productos" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Restaurante</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-productos"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: PEDIDOS -->
    <div id="tab-pedidos" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Pedidos</div>
            </div>
            <div class="filters">
                <select class="filter-select" id="filter-estado-pedido" onchange="loadPedidos()">
                    <option value="">Todos los estados</option>
                    <option value="PENDIENTE">Pendiente</option>
                    <option value="EN_PREPARACION">En Preparaci√≥n</option>
                    <option value="EN_CAMINO">En Camino</option>
                    <option value="ENTREGADO">Entregado</option>
                    <option value="CANCELADO">Cancelado</option>
                </select>
            </div>
            <div id="loader-pedidos" class="loader">Cargando...</div>
            <table id="table-pedidos" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-pedidos"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: CLIENTES -->
    <div id="tab-clientes" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Clientes Registrados</div>
            </div>
            <div id="loader-clientes" class="loader">Cargando...</div>
            <table id="table-clientes" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre Completo</th>
                    <th>Email</th>
                    <th>Tel√©fono</th>
                    <th>Direcci√≥n</th>
                    <th>Ciudad</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-clientes"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: REPARTIDORES -->
    <div id="tab-repartidores" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Repartidores</div>
                <button class="btn btn-primary" onclick="openRepartidorModal()">+ Nuevo Repartidor</button>
            </div>
            <div class="filters">
                <select class="filter-select" id="filter-activo" onchange="loadRepartidores()">
                    <option value="">Todos</option>
                    <option value="true">Activos</option>
                    <option value="false">Inactivos</option>
                </select>
            </div>
            <div id="loader-repartidores" class="loader">Cargando...</div>
            <table id="table-repartidores" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre Completo</th>
                    <th>Email</th>
                    <th>Tel√©fono</th>
                    <th>Matr√≠cula</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-repartidores"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL: RESTAURANTE -->
<div id="restauranteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="restauranteModalTitle">Nuevo Restaurante</div>
            <button class="close" onclick="closeRestauranteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="restauranteAlert" class="alert"></div>
            <form id="restauranteForm" onsubmit="submitRestaurante(event)">
                <input type="hidden" id="restauranteId">
                <div class="form-group">
                    <label class="form-label" for="restauranteNombre">Nombre *</label>
                    <input type="text" class="form-control" id="restauranteNombre" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="restauranteDescripcion">Descripci√≥n *</label>
                    <textarea class="form-control" id="restauranteDescripcion" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="restauranteDireccion">Direcci√≥n *</label>
                    <input type="text" class="form-control" id="restauranteDireccion" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="restauranteTelefono">Tel√©fono *</label>
                        <input type="tel" class="form-control" id="restauranteTelefono" pattern="[0-9]{9}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="restauranteActivo">Estado</label>
                        <select class="form-control" id="restauranteActivo">
                            <option value="true">Activo</option>
                            <option value="false">Inactivo</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="restauranteImagenUrl">URL Imagen</label>
                    <input type="url" class="form-control" id="restauranteImagenUrl">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: PRODUCTO -->
<div id="productoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="productoModalTitle">Nuevo Producto</div>
            <button class="close" onclick="closeProductoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="productoAlert" class="alert"></div>
            <form id="productoForm" onsubmit="submitProducto(event)">
                <input type="hidden" id="productoId">
                <div class="form-group">
                    <label class="form-label" for="productoNombre">Nombre *</label>
                    <input type="text" class="form-control" id="productoNombre" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="productoDescripcion">Descripci√≥n</label>
                    <textarea class="form-control" id="productoDescripcion"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="productoPrecio">Precio (‚Ç¨) *</label>
                        <input type="number" step="0.01" min="0.01" class="form-control" id="productoPrecio" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="productoStock">Stock *</label>
                        <input type="number" min="0" class="form-control" id="productoStock" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="productoRestaurante">Restaurante *</label>
                        <select class="form-control" id="productoRestaurante" required></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="productoDisponible">Disponible</label>
                        <select class="form-control" id="productoDisponible">
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: REPARTIDOR -->
<div id="repartidorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="repartidorModalTitle">Nuevo Repartidor</div>
            <button class="close" onclick="closeRepartidorModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="repartidorAlert" class="alert"></div>
            <form id="repartidorForm" onsubmit="submitRepartidor(event)">
                <input type="hidden" id="repartidorId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="repartidorNombre">Nombre *</label>
                        <input type="text" class="form-control" id="repartidorNombre" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="repartidorApellidos">Apellidos *</label>
                        <input type="text" class="form-control" id="repartidorApellidos" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="repartidorEmail">Email *</label>
                    <input type="email" class="form-control" id="repartidorEmail" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="repartidorTelefono">Tel√©fono *</label>
                        <input type="tel" class="form-control" id="repartidorTelefono" pattern="[0-9]{9}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="repartidorMatricula">Matr√≠cula *</label>
                        <input type="text" class="form-control" id="repartidorMatricula" pattern="[0-9]{4}[A-Z]{3}" placeholder="1234ABC" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: VER PEDIDO -->
<div id="pedidoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Detalle del Pedido</div>
            <button class="close" onclick="closePedidoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="pedidoDetalle"></div>
        </div>
    </div>
</div>

<!-- MODAL: CAMBIAR ESTADO PEDIDO -->
<div id="pedidoEstadoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Cambiar Estado del Pedido</div>
            <button class="close" onclick="closePedidoEstadoModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="pedidoEstadoAlert" class="alert"></div>
            <form id="pedidoEstadoForm" onsubmit="submitPedidoEstado(event)">
                <input type="hidden" id="pedidoEstadoId">
                <div class="form-group">
                    <label class="form-label" for="pedidoNuevoEstado">Nuevo Estado</label>
                    <select class="form-control" id="pedidoNuevoEstado" required>
                        <option value="PENDIENTE">Pendiente</option>
                        <option value="EN_PREPARACION">En Preparaci√≥n</option>
                        <option value="EN_CAMINO">En Camino</option>
                        <option value="ENTREGADO">Entregado</option>
                        <option value="CANCELADO">Cancelado</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Actualizar</button>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: ASIGNAR REPARTIDOR -->
<div id="asignarRepartidorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Asignar Repartidor</div>
            <button class="close" onclick="closeAsignarRepartidorModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="asignarRepartidorAlert" class="alert"></div>
            <form id="asignarRepartidorForm" onsubmit="submitAsignarRepartidor(event)">
                <input type="hidden" id="asignarPedidoId">
                <div class="form-group">
                    <label class="form-label" for="asignarRepartidorSelect">Seleccionar Repartidor</label>
                    <select class="form-control" id="asignarRepartidorSelect" required></select>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Asignar</button>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: VER CLIENTE -->
<div id="clienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Detalle del Cliente</div>
            <button class="close" onclick="closeClienteModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="clienteDetalle"></div>
        </div>
    </div>
</div>


<script>
    const API_URL = 'http://localhost:8080/api';
    let currentRestauranteId = null;
    let currentProductoId = null;
    let currentRepartidorId = null;

    // HELPER: Fetch con autenticaci√≥n
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            ...options.headers
        };

        return fetch(url, { ...options, headers });
    }

    // VERIFICACI√ìN DE AUTENTICACI√ìN Y ROL
    function checkAuth() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        const username = localStorage.getItem('username');

        if (!token || role !== 'ADMIN') {
            alert('Acceso no autorizado');
            window.location.href = 'login.html';
            return;
        }

        document.getElementById('adminUsername').textContent = username;
    }

    // CAMBIO DE TABS
    function switchTab(tab) {
        // Remover active de todos los tabs
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // Activar el tab seleccionado
        event.target.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');

        // Cargar datos del tab
        switch(tab) {
            case 'restaurantes':
                loadRestaurantes();
                break;
            case 'productos':
                loadProductos();
                break;
            case 'pedidos':
                loadPedidos();
                break;
            case 'clientes':
                loadClientes();
                break;
            case 'repartidores':
                loadRepartidores();
                break;
        }
    }

    // ESTAD√çSTICAS
    async function loadStats() {
        try {
            const [restaurantes, productos, pedidos, clientes, repartidores] = await Promise.all([
                fetchWithAuth(`${API_URL}/restaurantes?size=1`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/productos?size=1`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/pedidos?size=1`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/clientes?size=1`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/repartidores?size=1`).then(r => r.json())
            ]);

            document.getElementById('stat-restaurantes').textContent = restaurantes.totalElements || 0;
            document.getElementById('stat-productos').textContent = productos.totalElements || 0;
            document.getElementById('stat-pedidos').textContent = pedidos.totalElements || 0;
            document.getElementById('stat-clientes').textContent = clientes.totalElements || 0;
            document.getElementById('stat-repartidores').textContent = repartidores.totalElements || 0;
        } catch (error) {
            console.error('Error cargando estad√≠sticas:', error);
        }
    }

    // ===== RESTAURANTES =====
    async function loadRestaurantes() {
        const loader = document.getElementById('loader-restaurantes');
        const table = document.getElementById('table-restaurantes');
        const tbody = document.getElementById('tbody-restaurantes');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            const response = await fetchWithAuth(`${API_URL}/restaurantes?size=100`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';
            console.log('üçΩÔ∏è DEBUG RESTAURANTES - Total:', data.content.length);
            console.log('üçΩÔ∏è Primer restaurante completo:', data.content[0]);
            data.content.forEach(item => {
                console.log('üçΩÔ∏è Restaurante:', {
                    id: item.id,
                    nombre: item.nombre,
                    activo: item.activo,
                    tipo_activo: typeof item.activo,
                    activo_raw: JSON.stringify(item.activo)
                });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre}</td>
                    <td>${item.direccion}</td>
                    <td>${item.telefono || ''}</td>
                    <td><span class="badge ${item.activo === true ? 'badge-success' : 'badge-danger'}">${item.activo === true ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="editRestaurante(${item.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteRestaurante(${item.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function openRestauranteModal(id = null) {
        currentRestauranteId = id;
        document.getElementById('restauranteModalTitle').textContent = id ? 'Editar Restaurante' : 'Nuevo Restaurante';
        document.getElementById('restauranteForm').reset();
        document.getElementById('restauranteAlert').classList.remove('show');

        if (id) loadRestauranteData(id);

        document.getElementById('restauranteModal').classList.add('show');
    }

    function closeRestauranteModal() {
        document.getElementById('restauranteModal').classList.remove('show');
        currentRestauranteId = null;
    }

    async function loadRestauranteData(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/restaurantes/${id}`);
            const data = await response.json();

            document.getElementById('restauranteId').value = data.id;
            document.getElementById('restauranteNombre').value = data.nombre;
            document.getElementById('restauranteDescripcion').value = data.descripcion;
            document.getElementById('restauranteDireccion').value = data.direccion;
            document.getElementById('restauranteTelefono').value = data.telefono;
            document.getElementById('restauranteActivo').value = data.activo.toString();
            document.getElementById('restauranteImagenUrl').value = data.imagenUrl || '';
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function submitRestaurante(e) {
        e.preventDefault();

        const data = {
            nombre: document.getElementById('restauranteNombre').value,
            descripcion: document.getElementById('restauranteDescripcion').value,
            direccion: document.getElementById('restauranteDireccion').value,
            telefono: document.getElementById('restauranteTelefono').value,
            activo: document.getElementById('restauranteActivo').value === 'true',
            imagenUrl: document.getElementById('restauranteImagenUrl').value || null
        };

        try {
            const url = currentRestauranteId
                ? `${API_URL}/restaurantes/${currentRestauranteId}`
                : `${API_URL}/restaurantes`;

            const method = currentRestauranteId ? 'PUT' : 'POST';

            const response = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert('restauranteAlert', 'success', 'Restaurante guardado correctamente');
                setTimeout(() => {
                    closeRestauranteModal();
                    loadRestaurantes();
                    loadStats();
                    loadProductoSelects();
                }, 1000);
            } else {
                const error = await response.json();
                showAlert('restauranteAlert', 'error', error.message || 'Error al guardar');
            }
        } catch (error) {
            showAlert('restauranteAlert', 'error', 'Error de conexi√≥n');
        }
    }

    async function editRestaurante(id) {
        openRestauranteModal(id);
    }

    async function deleteRestaurante(id) {
        if (!confirm('¬øEliminar este restaurante?')) return;

        try {
            const response = await fetchWithAuth(`${API_URL}/restaurantes/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Restaurante eliminado');
                loadRestaurantes();
                loadStats();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al eliminar');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    // ===== PRODUCTOS =====
    async function loadProductos() {
        const loader = document.getElementById('loader-productos');
        const table = document.getElementById('table-productos');
        const tbody = document.getElementById('tbody-productos');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            let url = `${API_URL}/productos/filtrar?size=100`;

            const restauranteFilter = document.getElementById('filter-restaurante').value;
            const disponibleFilter = document.getElementById('filter-disponible').value;

            if (restauranteFilter) url += `&restauranteId=${restauranteFilter}`;
            if (disponibleFilter) url += `&disponible=${disponibleFilter}`;

            const response = await fetchWithAuth(url);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';
            data.content.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre}</td>
                    <td>${item.restauranteNombre}</td>
                    <td>‚Ç¨${item.precio}</td>
                    <td>${item.stock}</td>
                    <td><span class="badge ${item.disponible ? 'badge-success' : 'badge-danger'}">${item.disponible ? 'Disponible' : 'No disponible'}</span></td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="editProducto(${item.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteProducto(${item.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function loadProductoSelects() {
        try {
            // Cargar solo restaurantes
            const resRestaurantes = await fetchWithAuth(`${API_URL}/restaurantes?size=100`);
            const restaurantes = await resRestaurantes.json();

            const selectRestaurante = document.getElementById('productoRestaurante');
            const filterRestaurante = document.getElementById('filter-restaurante');

            selectRestaurante.innerHTML = '<option value="">Seleccionar restaurante...</option>';
            filterRestaurante.innerHTML = '<option value="">Todos los restaurantes</option>';

            restaurantes.content.forEach(r => {
                selectRestaurante.innerHTML += `<option value="${r.id}">${r.nombre}</option>`;
                filterRestaurante.innerHTML += `<option value="${r.id}">${r.nombre}</option>`;
            });

        } catch (error) {
            console.error('Error cargando selects:', error);
        }
    }

    // FIX PRINCIPAL: Cargar restaurantes ANTES de abrir el modal
    async function openProductoModal(id = null) {
        currentProductoId = id;
        document.getElementById('productoModalTitle').textContent = id ? 'Editar Producto' : 'Nuevo Producto';
        document.getElementById('productoForm').reset();
        document.getElementById('productoAlert').classList.remove('show');

        // IMPORTANTE: Cargar los restaurantes PRIMERO
        await loadProductoSelects();

        // Luego cargar los datos si es edici√≥n
        if (id) {
            await loadProductoData(id);
        }

        document.getElementById('productoModal').classList.add('show');
    }

    function closeProductoModal() {
        document.getElementById('productoModal').classList.remove('show');
        currentProductoId = null;
    }

    async function loadProductoData(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/productos/${id}`);
            const data = await response.json();

            document.getElementById('productoId').value = data.id;
            document.getElementById('productoNombre').value = data.nombre;
            document.getElementById('productoDescripcion').value = data.descripcion || '';
            document.getElementById('productoPrecio').value = data.precio;
            document.getElementById('productoStock').value = data.stock;
            document.getElementById('productoRestaurante').value = data.restauranteId;
            document.getElementById('productoDisponible').value = data.disponible.toString();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function submitProducto(e) {
        e.preventDefault();

        // Validar que se haya seleccionado un restaurante
        const restauranteId = document.getElementById('productoRestaurante').value;
        if (!restauranteId) {
            showAlert('productoAlert', 'error', 'Debe seleccionar un restaurante');
            return;
        }

        const descripcionValue = document.getElementById('productoDescripcion').value.trim();

        const data = {
            nombre: document.getElementById('productoNombre').value.trim(),
            descripcion: descripcionValue || null,
            precio: parseFloat(document.getElementById('productoPrecio').value),
            stock: parseInt(document.getElementById('productoStock').value),
            restauranteId: parseInt(restauranteId),
            // categoriaId se auto-asigna en el backend
            disponible: document.getElementById('productoDisponible').value === 'true'
        };

        console.log('üì¶ Enviando producto:', data);

        try {
            const url = currentProductoId
                ? `${API_URL}/productos/${currentProductoId}`
                : `${API_URL}/productos`;

            const method = currentProductoId ? 'PUT' : 'POST';

            const response = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert('productoAlert', 'success', 'Producto guardado correctamente');
                setTimeout(() => {
                    closeProductoModal();
                    loadProductos();
                    loadStats();
                }, 1000);
            } else {
                const error = await response.json();
                console.error('‚ùå Error del servidor:', error);
                showAlert('productoAlert', 'error', error.message || 'Error al guardar');
            }
        } catch (error) {
            console.error('‚ùå Error de conexi√≥n:', error);
            showAlert('productoAlert', 'error', 'Error de conexi√≥n');
        }
    }

    async function editProducto(id) {
        openProductoModal(id);
    }

    async function deleteProducto(id) {
        if (!confirm('¬øEliminar este producto?')) return;

        try {
            const response = await fetchWithAuth(`${API_URL}/productos/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Producto eliminado');
                loadProductos();
                loadStats();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al eliminar');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    // ===== PEDIDOS =====
    async function loadPedidos() {
        const loader = document.getElementById('loader-pedidos');
        const table = document.getElementById('table-pedidos');
        const tbody = document.getElementById('tbody-pedidos');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            const response = await fetchWithAuth(`${API_URL}/pedidos?size=100`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';
            let filtered = data.content;

            const estadoFilter = document.getElementById('filter-estado-pedido').value;
            if (estadoFilter) {
                filtered = filtered.filter(p => p.estado === estadoFilter);
            }

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.clienteNombre}</td>
                    <td>${item.fechaPedido}</td>
                    <td>${formatEstado(item.estado)}</td>
                    <td><strong>‚Ç¨${item.total}</strong></td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="viewPedido(${item.id})">Ver</button>
                            <button class="btn btn-primary" onclick="openPedidoEstadoModal(${item.id}, '${item.estado}')">Estado</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function formatEstado(estado) {
        const estados = {
            'PENDIENTE': '<span class="badge badge-warning">Pendiente</span>',
            'EN_PREPARACION': '<span class="badge badge-info">En Preparaci√≥n</span>',
            'EN_CAMINO': '<span class="badge badge-info">En Camino</span>',
            'ENTREGADO': '<span class="badge badge-success">Entregado</span>',
            'CANCELADO': '<span class="badge badge-danger">Cancelado</span>'
        };
        return estados[estado] || estado;
    }

    async function viewPedido(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/pedidos/${id}`);
            const data = await response.json();

            const detalle = document.getElementById('pedidoDetalle');
            detalle.innerHTML = `
                <div style="margin-bottom:1rem"><strong>Pedido #${data.id}</strong></div>
                <div style="margin-bottom:.5rem"><strong>Cliente:</strong> ${data.clienteNombre}</div>
                <div style="margin-bottom:.5rem"><strong>Repartidor:</strong> ${data.repartidorNombre || 'Sin asignar'}</div>
                <div style="margin-bottom:.5rem"><strong>Fecha:</strong> ${data.fechaPedido}</div>
                <div style="margin-bottom:.5rem"><strong>Estado:</strong> ${formatEstado(data.estado)}</div>
                <div style="margin-bottom:.5rem"><strong>Total:</strong> ‚Ç¨${data.total}</div>
                <hr style="margin:1rem 0">
                <div style="margin-bottom:1rem"><strong>Direcci√≥n de Entrega:</strong></div>
                <div>${data.direccionEntrega || '-'}</div>
                <div>${data.ciudadEntrega || '-'}, ${data.codigoPostalEntrega || '-'}</div>
                <div>${data.provinciaEntrega || '-'}, ${data.paisEntrega || '-'}</div>
                ${data.observaciones ? `<div style="margin-top:1rem"><strong>Observaciones:</strong> ${data.observaciones}</div>` : ''}
                <hr style="margin:1rem 0">
                <div style="margin-bottom:1rem"><strong>Productos:</strong></div>
                ${data.detalles.map(d => `
                    <div style="display:flex;justify-content:space-between;margin-bottom:.5rem">
                        <span>${d.cantidad}x ${d.productoNombre}</span>
                        <span>‚Ç¨${d.subtotal}</span>
                    </div>
                `).join('')}
            `;

            document.getElementById('pedidoModal').classList.add('show');
        } catch (error) {
            alert('Error al cargar el pedido');
        }
    }

    function closePedidoModal() {
        document.getElementById('pedidoModal').classList.remove('show');
    }

    function openPedidoEstadoModal(id, estadoActual) {
        document.getElementById('pedidoEstadoId').value = id;
        document.getElementById('pedidoNuevoEstado').value = estadoActual;
        document.getElementById('pedidoEstadoAlert').classList.remove('show');
        document.getElementById('pedidoEstadoModal').classList.add('show');
    }

    function closePedidoEstadoModal() {
        document.getElementById('pedidoEstadoModal').classList.remove('show');
    }

    async function submitPedidoEstado(e) {
        e.preventDefault();

        const id = document.getElementById('pedidoEstadoId').value;
        const nuevoEstado = document.getElementById('pedidoNuevoEstado').value;

        try {
            const response = await fetchWithAuth(`${API_URL}/pedidos/${id}/estado?estado=${nuevoEstado}`, {
                method: 'PATCH'
            });

            if (response.ok) {
                showAlert('pedidoEstadoAlert', 'success', 'Estado actualizado correctamente');
                setTimeout(() => {
                    closePedidoEstadoModal();
                    loadPedidos();
                }, 1000);
            } else {
                const error = await response.json();
                showAlert('pedidoEstadoAlert', 'error', error.message || 'Error al actualizar');
            }
        } catch (error) {
            showAlert('pedidoEstadoAlert', 'error', 'Error de conexi√≥n');
        }
    }

    async function openAsignarRepartidorModal(pedidoId) {
        document.getElementById('asignarPedidoId').value = pedidoId;
        document.getElementById('asignarRepartidorAlert').classList.remove('show');

        // Cargar repartidores activos
        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores/activos?size=100`);
            const data = await response.json();

            const select = document.getElementById('asignarRepartidorSelect');
            select.innerHTML = '<option value="">Seleccionar repartidor...</option>';

            data.content.forEach(r => {
                const option = document.createElement('option');
                option.value = r.id;
                option.textContent = `${r.nombre} ${r.apellidos} - ${r.matriculaVehiculo}`;
                select.appendChild(option);
            });

            document.getElementById('asignarRepartidorModal').classList.add('show');
        } catch (error) {
            alert('Error al cargar repartidores');
        }
    }

    function closeAsignarRepartidorModal() {
        document.getElementById('asignarRepartidorModal').classList.remove('show');
    }

    async function submitAsignarRepartidor(e) {
        e.preventDefault();

        const pedidoId = document.getElementById('asignarPedidoId').value;
        const repartidorId = document.getElementById('asignarRepartidorSelect').value;

        try {
            const response = await fetchWithAuth(
                `${API_URL}/pedidos/${pedidoId}/asignar-repartidor?repartidorId=${repartidorId}`,
                { method: 'PATCH' }
            );

            if (response.ok) {
                showAlert('asignarRepartidorAlert', 'success', 'Repartidor asignado correctamente');
                setTimeout(() => {
                    closeAsignarRepartidorModal();
                    loadPedidos();
                }, 1000);
            } else {
                const error = await response.json();
                showAlert('asignarRepartidorAlert', 'error', error.message || 'Error al asignar');
            }
        } catch (error) {
            showAlert('asignarRepartidorAlert', 'error', 'Error de conexi√≥n');
        }
    }

    // ===== CLIENTES =====
    async function loadClientes() {
        const loader = document.getElementById('loader-clientes');
        const table = document.getElementById('table-clientes');
        const tbody = document.getElementById('tbody-clientes');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            const response = await fetchWithAuth(`${API_URL}/clientes?size=100`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';
            data.content.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre || ''} ${item.apellidos || ''}</td>
                    <td>${item.email || ''}</td>
                    <td>${item.telefono || ''}</td>
                    <td>${item.direccion || '-'}</td>
                    <td>${item.ciudad || '-'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewCliente(${item.id})">Ver</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function viewCliente(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/clientes/${id}`);
            const data = await response.json();

            const detalle = document.getElementById('clienteDetalle');
            detalle.innerHTML = `
                <div style="margin-bottom:1rem"><strong>Cliente #${data.id}</strong></div>
                <div style="margin-bottom:.5rem"><strong>Nombre:</strong> ${data.nombre || ''} ${data.apellidos || ''}</div>
                <div style="margin-bottom:.5rem"><strong>Email:</strong> ${data.email || '-'}</div>
                <div style="margin-bottom:.5rem"><strong>Tel√©fono:</strong> ${data.telefono || '-'}</div>
                <hr style="margin:1rem 0">
                <div style="margin-bottom:1rem"><strong>Direcci√≥n:</strong></div>
                <div>${data.direccion || '-'}</div>
                <div>${data.ciudad || '-'}, ${data.codigoPostal || '-'}</div>
                <div>${data.provincia || '-'}, ${data.pais || '-'}</div>
            `;

            document.getElementById('clienteModal').classList.add('show');
        } catch (error) {
            alert('Error al cargar el cliente');
        }
    }

    function closeClienteModal() {
        document.getElementById('clienteModal').classList.remove('show');
    }

    // ===== REPARTIDORES =====
    async function loadRepartidores() {
        const loader = document.getElementById('loader-repartidores');
        const table = document.getElementById('table-repartidores');
        const tbody = document.getElementById('tbody-repartidores');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores?size=100`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';

            let filtered = data.content;
            const activoFilter = document.getElementById('filter-activo').value;
            if (activoFilter) {
                filtered = filtered.filter(r => r.activo.toString() === activoFilter);
            }

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre} ${item.apellidos}</td>
                    <td>${item.email || ''}</td>
                    <td>${item.telefono || ''}</td>
                    <td>${item.matriculaVehiculo || ''}</td>
                    <td><span class="badge ${item.activo ? 'badge-success' : 'badge-danger'}">${item.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <div class="actions">
                            <button class="btn ${item.activo ? 'btn-secondary' : 'btn-success'}" onclick="toggleRepartidorEstado(${item.id}, ${!item.activo})">
                                ${item.activo ? 'Desactivar' : 'Activar'}
                            </button>
                            <button class="btn btn-secondary" onclick="editRepartidor(${item.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteRepartidor(${item.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function openRepartidorModal(id = null) {
        currentRepartidorId = id;
        document.getElementById('repartidorModalTitle').textContent = id ? 'Editar Repartidor' : 'Nuevo Repartidor';
        document.getElementById('repartidorForm').reset();
        document.getElementById('repartidorAlert').classList.remove('show');

        if (id) loadRepartidorData(id);

        document.getElementById('repartidorModal').classList.add('show');
    }

    function closeRepartidorModal() {
        document.getElementById('repartidorModal').classList.remove('show');
        currentRepartidorId = null;
    }

    async function loadRepartidorData(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores/${id}`);
            const data = await response.json();

            document.getElementById('repartidorId').value = data.id;
            document.getElementById('repartidorNombre').value = data.nombre;
            document.getElementById('repartidorApellidos').value = data.apellidos;
            document.getElementById('repartidorEmail').value = data.email;
            document.getElementById('repartidorTelefono').value = data.telefono;
            document.getElementById('repartidorMatricula').value = data.matriculaVehiculo;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function submitRepartidor(e) {
        e.preventDefault();

        const data = {
            nombre: document.getElementById('repartidorNombre').value,
            apellidos: document.getElementById('repartidorApellidos').value,
            email: document.getElementById('repartidorEmail').value,
            telefono: document.getElementById('repartidorTelefono').value,
            matriculaVehiculo: document.getElementById('repartidorMatricula').value.toUpperCase()
        };

        try {
            const url = currentRepartidorId
                ? `${API_URL}/repartidores/${currentRepartidorId}`
                : `${API_URL}/repartidores`;

            const method = currentRepartidorId ? 'PUT' : 'POST';

            const response = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert('repartidorAlert', 'success', 'Repartidor guardado correctamente');
                setTimeout(() => {
                    closeRepartidorModal();
                    loadRepartidores();
                    loadStats();
                }, 1000);
            } else {
                const error = await response.json();
                showAlert('repartidorAlert', 'error', error.message || 'Error al guardar');
            }
        } catch (error) {
            showAlert('repartidorAlert', 'error', 'Error de conexi√≥n');
        }
    }

    async function editRepartidor(id) {
        openRepartidorModal(id);
    }

    async function deleteRepartidor(id) {
        if (!confirm('¬øEliminar este repartidor?')) return;

        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Repartidor eliminado');
                loadRepartidores();
                loadStats();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al eliminar');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    async function toggleRepartidorEstado(id, nuevoEstado) {
        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores/${id}/estado?activo=${nuevoEstado}`, {
                method: 'PATCH'
            });

            if (response.ok) {
                alert(`Repartidor ${nuevoEstado ? 'activado' : 'desactivado'} correctamente`);
                loadRepartidores();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al cambiar estado');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    // UTILIDADES
    function showAlert(id, type, message) {
        const alert = document.getElementById(id);
        alert.className = `alert alert-${type} show`;
        alert.textContent = message;
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }

    // INICIALIZACI√ìN
    checkAuth();
    loadStats();
    loadRestaurantes();
    loadProductoSelects();

</script>

</body>

</html>