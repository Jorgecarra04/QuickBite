<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickBite - Panel Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --primary:#ff6b35;
            --secondary:#0f172a;
            --bg:#f4f6f9;
            --white:#ffffff;
            --gray:#6b7280;
            --border:#e5e7eb;
            --success:#06d6a0;
            --danger:#ef476f;
            --shadow:0 10px 25px rgba(0,0,0,0.08);
        }

        *{margin:0;padding:0;box-sizing:border-box;}

        body{
            font-family:'Outfit',sans-serif;
            background:var(--bg);
            color:var(--secondary);
        }

        .navbar{
            background:var(--secondary);
            color:white;
            padding:1rem 1.5rem;
            position:sticky;
            top:0;
            z-index:100;
            box-shadow:var(--shadow);
        }

        .nav-container{
            max-width:1400px;
            margin:0 auto;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .brand{
            font-size:1.8rem;
            font-weight:700;
        }

        .nav-right{
            display:flex;
            gap:1rem;
            align-items:center;
        }

        .username{
            font-weight:600;
        }

        .btn-logout{
            background:rgba(255,255,255,.15);
            border:1px solid white;
            color:white;
            padding:.6rem 1.2rem;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
            transition:.2s;
        }

        .btn-logout:hover{
            background:white;
            color:var(--secondary);
        }

        .container{
            max-width:1400px;
            margin:0 auto;
            padding:2rem 1.5rem;
        }

        .header{
            margin-bottom:2rem;
        }

        .title{
            font-size:2rem;
            font-weight:700;
            margin-bottom:.5rem;
        }

        .subtitle{
            color:var(--gray);
        }

        .stats{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
            gap:1.5rem;
            margin-bottom:2rem;
        }

        .stat-card{
            background:white;
            border:1px solid var(--border);
            border-radius:12px;
            padding:1.5rem;
            transition:.2s;
        }

        .stat-card:hover{
            box-shadow:var(--shadow);
            transform:translateY(-2px);
        }

        .stat-value{
            font-size:2.5rem;
            font-weight:700;
            color:var(--primary);
            margin-bottom:.3rem;
        }

        .stat-label{
            color:var(--gray);
            font-weight:600;
        }

        .tabs{
            display:flex;
            gap:.8rem;
            margin-bottom:2rem;
            flex-wrap:wrap;
        }

        .tab-btn{
            padding:.8rem 1.5rem;
            border:1px solid var(--border);
            background:white;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
            transition:.2s;
        }

        .tab-btn:hover{
            border-color:var(--primary);
            color:var(--primary);
        }

        .tab-btn.active{
            background:var(--primary);
            color:white;
            border-color:var(--primary);
        }

        .tab-content{
            display:none;
        }

        .tab-content.active{
            display:block;
        }

        .card{
            background:white;
            border:1px solid var(--border);
            border-radius:12px;
            padding:1.5rem;
            margin-bottom:1.5rem;
        }

        .card-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:1.5rem;
            padding-bottom:1rem;
            border-bottom:1px solid var(--border);
        }

        .card-title{
            font-size:1.3rem;
            font-weight:700;
        }

        .btn{
            padding:.7rem 1.2rem;
            border:none;
            border-radius:8px;
            font-weight:600;
            cursor:pointer;
            font-size:.9rem;
            transition:.2s;
        }

        .btn-primary{background:var(--primary);color:white;}
        .btn-primary:hover{background:#e85b2a;}
        .btn-success{background:var(--success);color:white;}
        .btn-success:hover{background:#05c496;}
        .btn-danger{background:var(--danger);color:white;}
        .btn-danger:hover{background:#e03060;}
        .btn-secondary{background:var(--secondary);color:white;}
        .btn-secondary:hover{background:#1e293b;}

        .filters{
            display:flex;
            gap:.8rem;
            margin-bottom:1.5rem;
            flex-wrap:wrap;
        }

        .filter-select{
            padding:.7rem 1rem;
            border:1px solid var(--border);
            border-radius:8px;
            font-size:.9rem;
            min-width:150px;
        }

        table{
            width:100%;
            border-collapse:collapse;
        }

        th{
            background:var(--bg);
            padding:1rem;
            text-align:left;
            font-weight:700;
            border-bottom:2px solid var(--border);
        }

        td{
            padding:1rem;
            border-bottom:1px solid var(--border);
        }

        tr:hover{
            background:var(--bg);
        }

        .badge{
            display:inline-block;
            padding:.3rem .8rem;
            border-radius:6px;
            font-size:.85rem;
            font-weight:600;
        }

        .badge-success{background:#d1fae5;color:#065f46;}
        .badge-danger{background:#fee2e2;color:#991b1b;}
        .badge-warning{background:#fef3c7;color:#92400e;}
        .badge-info{background:#dbeafe;color:#1e40af;}

        .actions{
            display:flex;
            gap:.5rem;
            flex-wrap:wrap;
        }

        .modal{
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,.5);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:1000;
        }

        .modal.show{
            display:flex;
        }

        .modal-content{
            background:white;
            border-radius:12px;
            width:90%;
            max-width:600px;
            max-height:90vh;
            overflow-y:auto;
        }

        .modal-header{
            padding:1.5rem;
            border-bottom:1px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .modal-title{
            font-size:1.5rem;
            font-weight:700;
        }

        .close{
            background:none;
            border:none;
            font-size:1.5rem;
            cursor:pointer;
            color:var(--gray);
        }

        .modal-body{
            padding:1.5rem;
        }

        .form-group{
            margin-bottom:1.2rem;
        }

        .form-label{
            display:block;
            font-weight:600;
            margin-bottom:.5rem;
            font-size:.9rem;
        }

        .form-control{
            width:100%;
            padding:.8rem 1rem;
            border:1px solid var(--border);
            border-radius:8px;
            font-size:.95rem;
        }

        .form-control:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(255,107,53,.15);
        }

        textarea.form-control{
            resize:vertical;
            min-height:100px;
        }

        .form-row{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:1rem;
        }

        .alert{
            padding:.9rem 1rem;
            border-radius:8px;
            margin-bottom:1rem;
            display:none;
        }

        .alert.show{
            display:block;
        }

        .alert-success{
            background:#d1fae5;
            color:#065f46;
        }

        .alert-error{
            background:#fee2e2;
            color:#991b1b;
        }

        .loader{
            text-align:center;
            padding:2rem;
            color:var(--gray);
        }

        .hidden{
            display:none !important;
        }

        .empty{
            text-align:center;
            padding:3rem;
            color:var(--gray);
        }

        .modal-actions{
            display:flex;
            gap:1rem;
            justify-content:flex-end;
            margin-top:1.5rem;
        }

        @media(max-width:768px){
            .form-row{
                grid-template-columns:1fr;
            }
            .stats{
                grid-template-columns:1fr;
            }
            .actions{
                flex-direction:column;
            }
            .actions .btn{
                width:100%;
            }
        }
    </style>
</head>

<body>

<div class="navbar">
    <div class="nav-container">
        <div class="brand">üçî QuickBite Admin</div>
        <div class="nav-right">
            <span class="username" id="adminUsername"></span>
            <button class="btn-logout" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div class="title">Panel de Administraci√≥n</div>
        <div class="subtitle">Gestiona tu plataforma de delivery</div>
    </div>

    <!-- ESTAD√çSTICAS -->
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="stat-restaurantes">0</div>
            <div class="stat-label">Restaurantes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-categorias">0</div>
            <div class="stat-label">Categor√≠as</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-productos">0</div>
            <div class="stat-label">Productos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-pedidos">0</div>
            <div class="stat-label">Pedidos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-clientes">0</div>
            <div class="stat-label">Clientes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-repartidores">0</div>
            <div class="stat-label">Repartidores</div>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('restaurantes')">Restaurantes</button>
        <button class="tab-btn" onclick="switchTab('categorias')">Categor√≠as</button>
        <button class="tab-btn" onclick="switchTab('productos')">Productos</button>
        <button class="tab-btn" onclick="switchTab('pedidos')">Pedidos</button>
        <button class="tab-btn" onclick="switchTab('clientes')">Clientes</button>
        <button class="tab-btn" onclick="switchTab('repartidores')">Repartidores</button>
    </div>

    <!-- TAB: RESTAURANTES -->
    <div id="tab-restaurantes" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Restaurantes</div>
                <button class="btn btn-primary" onclick="openRestauranteModal()">+ Nuevo Restaurante</button>
            </div>
            <div id="loader-restaurantes" class="loader">Cargando...</div>
            <table id="table-restaurantes" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Direcci√≥n</th>
                    <th>Tel√©fono</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-restaurantes"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: CATEGOR√çAS -->
    <div id="tab-categorias" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Categor√≠as de Productos</div>
                <button class="btn btn-primary" onclick="openCategoriaModal()">+ Nueva Categor√≠a</button>
            </div>
            <div id="loader-categorias" class="loader">Cargando...</div>
            <table id="table-categorias" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripci√≥n</th>
                    <th>Productos</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-categorias"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: PRODUCTOS -->
    <div id="tab-productos" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Productos</div>
                <button class="btn btn-primary" onclick="openProductoModal()">+ Nuevo Producto</button>
            </div>
            <div class="filters">
                <select class="filter-select" id="filter-restaurante" onchange="loadProductos()">
                    <option value="">Todos los restaurantes</option>
                </select>
                <select class="filter-select" id="filter-categoria" onchange="loadProductos()">
                    <option value="">Todas las categor√≠as</option>
                </select>
                <select class="filter-select" id="filter-disponible" onchange="loadProductos()">
                    <option value="">Todos los estados</option>
                    <option value="true">Disponibles</option>
                    <option value="false">No disponibles</option>
                </select>
            </div>
            <div id="loader-productos" class="loader">Cargando...</div>
            <table id="table-productos" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Restaurante</th>
                    <th>Categor√≠a</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-productos"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: PEDIDOS -->
    <div id="tab-pedidos" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Pedidos</div>
            </div>
            <div class="filters">
                <select class="filter-select" id="filter-estado-pedido" onchange="loadPedidos()">
                    <option value="">Todos los estados</option>
                    <option value="PENDIENTE">Pendiente</option>
                    <option value="EN_PREPARACION">En Preparaci√≥n</option>
                    <option value="EN_CAMINO">En Camino</option>
                    <option value="ENTREGADO">Entregado</option>
                    <option value="CANCELADO">Cancelado</option>
                </select>
            </div>
            <div id="loader-pedidos" class="loader">Cargando...</div>
            <table id="table-pedidos" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-pedidos"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: CLIENTES -->
    <div id="tab-clientes" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Clientes Registrados</div>
            </div>
            <div id="loader-clientes" class="loader">Cargando...</div>
            <table id="table-clientes" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre Completo</th>
                    <th>Email</th>
                    <th>Tel√©fono</th>
                    <th>Direcci√≥n</th>
                    <th>Ciudad</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-clientes"></tbody>
            </table>
        </div>
    </div>

    <!-- TAB: REPARTIDORES -->
    <div id="tab-repartidores" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Repartidores</div>
                <button class="btn btn-primary" onclick="openRepartidorModal()">+ Nuevo Repartidor</button>
            </div>
            <div class="filters">
                <select class="filter-select" id="filter-activo" onchange="loadRepartidores()">
                    <option value="">Todos</option>
                    <option value="true">Activos</option>
                    <option value="false">Inactivos</option>
                </select>
            </div>
            <div id="loader-repartidores" class="loader">Cargando...</div>
            <table id="table-repartidores" class="hidden">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre Completo</th>
                    <th>Email</th>
                    <th>Tel√©fono</th>
                    <th>Matr√≠cula</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tbody-repartidores"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL: RESTAURANTE -->
<div id="restauranteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="restauranteModalTitle">Nuevo Restaurante</div>
            <button class="close" onclick="closeRestauranteModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="restauranteAlert" class="alert"></div>
            <form id="restauranteForm" onsubmit="submitRestaurante(event)">
                <input type="hidden" id="restauranteId">
                <div class="form-group">
                    <label class="form-label" for="restauranteNombre">Nombre *</label>
                    <input type="text" class="form-control" id="restauranteNombre" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="restauranteDescripcion">Descripci√≥n</label>
                    <textarea class="form-control" id="restauranteDescripcion"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="restauranteDireccion">Direcci√≥n *</label>
                    <input type="text" class="form-control" id="restauranteDireccion" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="restauranteTelefono">Tel√©fono *</label>
                    <input type="tel" class="form-control" id="restauranteTelefono" pattern="[0-9]{9}" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="restauranteImagenUrl">URL de Imagen</label>
                    <input type="url" class="form-control" id="restauranteImagenUrl">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRestauranteModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: CATEGOR√çA -->
<div id="categoriaModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="categoriaModalTitle">Nueva Categor√≠a</div>
            <button class="close" onclick="closeCategoriaModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="categoriaAlert" class="alert"></div>
            <form id="categoriaForm" onsubmit="submitCategoria(event)">
                <input type="hidden" id="categoriaId">
                <div class="form-group">
                    <label class="form-label" for="categoriaNombre">Nombre *</label>
                    <input type="text" class="form-control" id="categoriaNombre" required maxlength="50">
                    <small style="color:var(--gray);font-size:.85rem;">Ej: Pizzas, Hamburguesas, Postres, Bebidas</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="categoriaDescripcion">Descripci√≥n</label>
                    <textarea class="form-control" id="categoriaDescripcion" maxlength="200"></textarea>
                    <small style="color:var(--gray);font-size:.85rem;">Descripci√≥n opcional de la categor√≠a</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoriaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: PRODUCTO -->
<div id="productoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="productoModalTitle">Nuevo Producto</div>
            <button class="close" onclick="closeProductoModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="productoAlert" class="alert"></div>
            <form id="productoForm" onsubmit="submitProducto(event)">
                <input type="hidden" id="productoId">
                <div class="form-group">
                    <label class="form-label" for="productoNombre">Nombre *</label>
                    <input type="text" class="form-control" id="productoNombre" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="productoDescripcion">Descripci√≥n</label>
                    <textarea class="form-control" id="productoDescripcion"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="productoPrecio">Precio (‚Ç¨) *</label>
                        <input type="number" class="form-control" id="productoPrecio" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="productoStock">Stock *</label>
                        <input type="number" class="form-control" id="productoStock" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="productoRestaurante">Restaurante *</label>
                    <select class="form-control" id="productoRestaurante" required>
                        <option value="">Seleccionar restaurante</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="productoCategoria">Categor√≠a *</label>
                    <select class="form-control" id="productoCategoria" required>
                        <option value="">Seleccionar categor√≠a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:.5rem;">
                        <input type="checkbox" id="productoDisponible" checked>
                        <span class="form-label" style="margin:0;">Disponible</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProductoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- MODAL: PEDIDO DETALLE -->
<div id="pedidoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Detalle del Pedido</div>
            <button class="close" onclick="closePedidoModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="pedidoDetalle"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePedidoModal()">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: CLIENTE DETALLE -->
<div id="clienteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Detalle del Cliente</div>
            <button class="close" onclick="closeClienteModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="clienteDetalle"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeClienteModal()">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: REPARTIDOR -->
<div id="repartidorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="repartidorModalTitle">Nuevo Repartidor</div>
            <button class="close" onclick="closeRepartidorModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="repartidorAlert" class="alert"></div>
            <form id="repartidorForm" onsubmit="submitRepartidor(event)">
                <input type="hidden" id="repartidorId">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="repartidorNombre">Nombre *</label>
                        <input type="text" class="form-control" id="repartidorNombre" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="repartidorApellidos">Apellidos *</label>
                        <input type="text" class="form-control" id="repartidorApellidos" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="repartidorEmail">Email *</label>
                    <input type="email" class="form-control" id="repartidorEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="repartidorTelefono">Tel√©fono *</label>
                    <input type="tel" class="form-control" id="repartidorTelefono" pattern="[0-9]{9}" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="repartidorMatricula">Matr√≠cula Veh√≠culo *</label>
                    <input type="text" class="form-control" id="repartidorMatricula" pattern="[0-9]{4}[A-Z]{3}" placeholder="1234ABC" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRepartidorModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api';
    let currentRestauranteId = null;
    let currentCategoriaId = null;
    let currentProductoId = null;
    let currentRepartidorId = null;

    // AUTH
    function checkAuth() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        const username = localStorage.getItem('username');

        if (!token || role !== 'ADMIN') {
            window.location.href = 'login.html';
            return;
        }

        document.getElementById('adminUsername').textContent = username;
    }

    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('token');
        return fetch(url, {
            ...options,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            }
        });
    }

    // TABS
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');

        if (tabName === 'restaurantes') loadRestaurantes();
        if (tabName === 'categorias') loadCategorias();
        if (tabName === 'productos') loadProductos();
        if (tabName === 'pedidos') loadPedidos();
        if (tabName === 'clientes') loadClientes();
        if (tabName === 'repartidores') loadRepartidores();
    }

    // ESTAD√çSTICAS
    async function loadStats() {
        try {
            const [restaurantes, categorias, productos, pedidos, clientes, repartidores] = await Promise.all([
                fetchWithAuth(`${API_URL}/restaurantes?size=1000`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/categorias`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/productos?size=1000`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/pedidos?size=1000`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/clientes?size=1000`).then(r => r.json()),
                fetchWithAuth(`${API_URL}/repartidores?size=1000`).then(r => r.json())
            ]);

            document.getElementById('stat-restaurantes').textContent = restaurantes.totalElements || 0;
            document.getElementById('stat-categorias').textContent = categorias.length || 0;
            document.getElementById('stat-productos').textContent = productos.totalElements || 0;
            document.getElementById('stat-pedidos').textContent = pedidos.totalElements || 0;
            document.getElementById('stat-clientes').textContent = clientes.totalElements || 0;
            document.getElementById('stat-repartidores').textContent = repartidores.totalElements || 0;
        } catch (error) {
            console.error('Error cargando estad√≠sticas:', error);
        }
    }

    // ===== RESTAURANTES =====
    async function loadRestaurantes() {
        const loader = document.getElementById('loader-restaurantes');
        const table = document.getElementById('table-restaurantes');
        const tbody = document.getElementById('tbody-restaurantes');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            const response = await fetchWithAuth(`${API_URL}/restaurantes?size=100`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';
            data.content.forEach(item => {
                const tr = document.createElement('tr');
                // Si activo es null, lo tratamos como inactivo
                const esActivo = item.activo === true || item.activo === 1 || item.activo === '1';
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre}</td>
                    <td>${item.direccion || '-'}</td>
                    <td>${item.telefono || '-'}</td>
                    <td><span class="badge ${esActivo ? 'badge-success' : 'badge-danger'}">${esActivo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="editRestaurante(${item.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteRestaurante(${item.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function openRestauranteModal(id = null) {
        currentRestauranteId = id;
        document.getElementById('restauranteModalTitle').textContent = id ? 'Editar Restaurante' : 'Nuevo Restaurante';
        document.getElementById('restauranteForm').reset();
        document.getElementById('restauranteAlert').classList.remove('show');

        if (id) loadRestauranteData(id);

        document.getElementById('restauranteModal').classList.add('show');
    }

    function closeRestauranteModal() {
        document.getElementById('restauranteModal').classList.remove('show');
        currentRestauranteId = null;
    }

    async function loadRestauranteData(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/restaurantes/${id}`);
            const data = await response.json();

            document.getElementById('restauranteId').value = data.id;
            document.getElementById('restauranteNombre').value = data.nombre;
            document.getElementById('restauranteDescripcion').value = data.descripcion || '';
            document.getElementById('restauranteDireccion').value = data.direccion;
            document.getElementById('restauranteTelefono').value = data.telefono;
            document.getElementById('restauranteImagenUrl').value = data.imagenUrl || '';
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function submitRestaurante(e) {
        e.preventDefault();

        const data = {
            nombre: document.getElementById('restauranteNombre').value,
            descripcion: document.getElementById('restauranteDescripcion').value,
            direccion: document.getElementById('restauranteDireccion').value,
            telefono: document.getElementById('restauranteTelefono').value,
            imagenUrl: document.getElementById('restauranteImagenUrl').value,
            activo: true
        };

        try {
            const url = currentRestauranteId
                ? `${API_URL}/restaurantes/${currentRestauranteId}`
                : `${API_URL}/restaurantes`;

            const method = currentRestauranteId ? 'PUT' : 'POST';

            const response = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert('restauranteAlert', 'success', 'Restaurante guardado correctamente');
                setTimeout(() => {
                    closeRestauranteModal();
                    loadRestaurantes();
                    loadStats();
                    loadProductoSelects();
                }, 1000);
            } else {
                const error = await response.json();
                showAlert('restauranteAlert', 'error', error.message || 'Error al guardar');
            }
        } catch (error) {
            showAlert('restauranteAlert', 'error', 'Error de conexi√≥n');
        }
    }

    async function editRestaurante(id) {
        openRestauranteModal(id);
    }

    async function deleteRestaurante(id) {
        if (!confirm('¬øEliminar este restaurante? Tambi√©n se eliminar√°n todos sus productos.')) return;

        try {
            const response = await fetchWithAuth(`${API_URL}/restaurantes/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Restaurante eliminado');
                loadRestaurantes();
                loadStats();
                loadProductoSelects();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al eliminar');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    // ===== CATEGOR√çAS =====
    async function loadCategorias() {
        const loader = document.getElementById('loader-categorias');
        const table = document.getElementById('table-categorias');
        const tbody = document.getElementById('tbody-categorias');

        loader.style.display = 'block';
        table.style.display = 'none';

        try {
            const response = await fetchWithAuth(`${API_URL}/categorias`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');
            table.style.display = 'table';

            tbody.innerHTML = '';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre}</td>
                    <td>${item.descripcion || '-'}</td>
                    <td><span class="badge badge-info">${item.productosCount || 0}</span></td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="editCategoria(${item.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteCategoria(${item.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
            loader.style.display = 'none';
            table.style.display = 'table';
        }
    }

    function openCategoriaModal(id = null) {
        currentCategoriaId = id;
        document.getElementById('categoriaModalTitle').textContent = id ? 'Editar Categor√≠a' : 'Nueva Categor√≠a';
        document.getElementById('categoriaForm').reset();
        document.getElementById('categoriaAlert').classList.remove('show');

        if (id) loadCategoriaData(id);

        document.getElementById('categoriaModal').classList.add('show');
    }

    function closeCategoriaModal() {
        document.getElementById('categoriaModal').classList.remove('show');
        currentCategoriaId = null;
    }

    async function loadCategoriaData(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/categorias/${id}`);
            const data = await response.json();

            document.getElementById('categoriaId').value = data.id;
            document.getElementById('categoriaNombre').value = data.nombre;
            document.getElementById('categoriaDescripcion').value = data.descripcion || '';
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function submitCategoria(e) {
        e.preventDefault();

        const data = {
            nombre: document.getElementById('categoriaNombre').value.trim(),
            descripcion: document.getElementById('categoriaDescripcion').value.trim()
        };

        try {
            const url = currentCategoriaId
                ? `${API_URL}/categorias/${currentCategoriaId}`
                : `${API_URL}/categorias`;

            const method = currentCategoriaId ? 'PUT' : 'POST';

            const response = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert('categoriaAlert', 'success', 'Categor√≠a guardada correctamente');
                setTimeout(() => {
                    closeCategoriaModal();
                    loadCategorias();
                    loadStats();
                    loadProductoSelects();
                }, 1000);
            } else {
                const error = await response.json();
                showAlert('categoriaAlert', 'error', error.message || 'Error al guardar');
            }
        } catch (error) {
            showAlert('categoriaAlert', 'error', 'Error de conexi√≥n');
        }
    }

    async function editCategoria(id) {
        openCategoriaModal(id);
    }

    async function deleteCategoria(id) {
        if (!confirm('¬øEliminar esta categor√≠a? Los productos asociados quedar√°n sin categor√≠a.')) return;

        try {
            const response = await fetchWithAuth(`${API_URL}/categorias/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Categor√≠a eliminada');
                loadCategorias();
                loadStats();
                loadProductoSelects();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al eliminar');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    // ===== PRODUCTOS =====
    async function loadProductoSelects() {
        try {
            // Cargar restaurantes
            const restaurantesRes = await fetchWithAuth(`${API_URL}/restaurantes?size=100`);
            const restaurantes = await restaurantesRes.json();

            const selectRestaurante = document.getElementById('productoRestaurante');
            const filterRestaurante = document.getElementById('filter-restaurante');

            selectRestaurante.innerHTML = '<option value="">Seleccionar restaurante</option>';
            filterRestaurante.innerHTML = '<option value="">Todos los restaurantes</option>';

            restaurantes.content.forEach(r => {
                selectRestaurante.innerHTML += `<option value="${r.id}">${r.nombre}</option>`;
                filterRestaurante.innerHTML += `<option value="${r.id}">${r.nombre}</option>`;
            });

            // Cargar categor√≠as
            const categoriasRes = await fetchWithAuth(`${API_URL}/categorias`);
            const categorias = await categoriasRes.json();

            const selectCategoria = document.getElementById('productoCategoria');
            const filterCategoria = document.getElementById('filter-categoria');

            selectCategoria.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
            filterCategoria.innerHTML = '<option value="">Todas las categor√≠as</option>';

            categorias.forEach(c => {
                selectCategoria.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                filterCategoria.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
            });
        } catch (error) {
            console.error('Error cargando selects:', error);
        }
    }

    async function loadProductos() {
        const loader = document.getElementById('loader-productos');
        const table = document.getElementById('table-productos');
        const tbody = document.getElementById('tbody-productos');

        loader.style.display = 'block';
        table.classList.add('hidden');

        const restauranteId = document.getElementById('filter-restaurante').value;
        const categoriaId = document.getElementById('filter-categoria').value;
        const disponible = document.getElementById('filter-disponible').value;

        let url = `${API_URL}/productos/filtrar?size=100`;
        if (restauranteId) url += `&restauranteId=${restauranteId}`;
        if (categoriaId) url += `&categoriaId=${categoriaId}`;
        if (disponible) url += `&disponible=${disponible}`;

        try {
            const response = await fetchWithAuth(url);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';
            data.content.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre}</td>
                    <td>${item.restauranteNombre || '-'}</td>
                    <td>${item.categoriaNombre || '-'}</td>
                    <td><strong>${item.precio}‚Ç¨</strong></td>
                    <td><span class="badge badge-warning">${item.stock}</span></td>
                    <td><span class="badge ${item.disponible ? 'badge-success' : 'badge-danger'}">${item.disponible ? 'Disponible' : 'No disponible'}</span></td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="editProducto(${item.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteProducto(${item.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function openProductoModal(id = null) {
        currentProductoId = id;
        document.getElementById('productoModalTitle').textContent = id ? 'Editar Producto' : 'Nuevo Producto';
        document.getElementById('productoForm').reset();
        document.getElementById('productoAlert').classList.remove('show');
        document.getElementById('productoDisponible').checked = true;

        if (id) loadProductoData(id);

        document.getElementById('productoModal').classList.add('show');
    }

    function closeProductoModal() {
        document.getElementById('productoModal').classList.remove('show');
        currentProductoId = null;
    }

    async function loadProductoData(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/productos/${id}`);
            const data = await response.json();

            document.getElementById('productoId').value = data.id;
            document.getElementById('productoNombre').value = data.nombre;
            document.getElementById('productoDescripcion').value = data.descripcion || '';
            document.getElementById('productoPrecio').value = data.precio;
            document.getElementById('productoStock').value = data.stock;
            document.getElementById('productoRestaurante').value = data.restauranteId || '';
            document.getElementById('productoCategoria').value = data.categoriaId || '';
            document.getElementById('productoDisponible').checked = data.disponible;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function submitProducto(e) {
        e.preventDefault();

        const data = {
            nombre: document.getElementById('productoNombre').value,
            descripcion: document.getElementById('productoDescripcion').value,
            precio: parseFloat(document.getElementById('productoPrecio').value),
            stock: parseInt(document.getElementById('productoStock').value),
            restauranteId: parseInt(document.getElementById('productoRestaurante').value),
            categoriaId: parseInt(document.getElementById('productoCategoria').value) || null,
            disponible: document.getElementById('productoDisponible').checked
        };

        try {
            const url = currentProductoId
                ? `${API_URL}/productos/${currentProductoId}`
                : `${API_URL}/productos`;

            const method = currentProductoId ? 'PUT' : 'POST';

            const response = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert('productoAlert', 'success', 'Producto guardado correctamente');
                setTimeout(() => {
                    closeProductoModal();
                    loadProductos();
                    loadStats();
                }, 1000);
            } else {
                const error = await response.json();
                showAlert('productoAlert', 'error', error.message || 'Error al guardar');
            }
        } catch (error) {
            showAlert('productoAlert', 'error', 'Error de conexi√≥n');
        }
    }

    async function editProducto(id) {
        openProductoModal(id);
    }

    async function deleteProducto(id) {
        if (!confirm('¬øEliminar este producto?')) return;

        try {
            const response = await fetchWithAuth(`${API_URL}/productos/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Producto eliminado');
                loadProductos();
                loadStats();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al eliminar');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    // ===== PEDIDOS =====
    async function loadPedidos() {
        const loader = document.getElementById('loader-pedidos');
        const table = document.getElementById('table-pedidos');
        const tbody = document.getElementById('tbody-pedidos');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            const response = await fetchWithAuth(`${API_URL}/pedidos?size=100`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            const estadoFilter = document.getElementById('filter-estado-pedido').value;
            let pedidos = data.content;

            if (estadoFilter) {
                pedidos = pedidos.filter(p => p.estado === estadoFilter);
            }

            tbody.innerHTML = '';
            pedidos.forEach(item => {
                const estadoBadge = {
                    'PENDIENTE': 'badge-warning',
                    'EN_PREPARACION': 'badge-info',
                    'EN_CAMINO': 'badge-info',
                    'ENTREGADO': 'badge-success',
                    'CANCELADO': 'badge-danger'
                };

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.clienteNombre}</td>
                    <td>${item.fechaPedido}</td>
                    <td><span class="badge ${estadoBadge[item.estado] || 'badge-info'}">${item.estado}</span></td>
                    <td><strong>${item.total}‚Ç¨</strong></td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewPedido(${item.id})">Ver</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function viewPedido(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/pedidos/${id}`);
            const data = await response.json();

            let detallesHTML = '';
            if (data.detalles && data.detalles.length > 0) {
                detallesHTML = '<div style="margin-top:1rem"><strong>Productos:</strong><ul style="margin-left:1.5rem;margin-top:.5rem">';
                data.detalles.forEach(d => {
                    detallesHTML += `<li>${d.productoNombre} x ${d.cantidad} - ${d.subtotal}‚Ç¨</li>`;
                });
                detallesHTML += '</ul></div>';
            }

            const detalle = document.getElementById('pedidoDetalle');
            detalle.innerHTML = `
                <div style="margin-bottom:1rem"><strong>Pedido #${data.id}</strong></div>
                <div style="margin-bottom:.5rem"><strong>Cliente:</strong> ${data.clienteNombre}</div>
                <div style="margin-bottom:.5rem"><strong>Fecha:</strong> ${data.fechaPedido}</div>
                <div style="margin-bottom:.5rem"><strong>Estado:</strong> ${data.estado}</div>
                <div style="margin-bottom:.5rem"><strong>Total:</strong> ${data.total}‚Ç¨</div>
                ${data.repartidorNombre ? `<div style="margin-bottom:.5rem"><strong>Repartidor:</strong> ${data.repartidorNombre}</div>` : ''}
                <hr style="margin:1rem 0">
                <div><strong>Direcci√≥n de entrega:</strong></div>
                <div>${data.direccionEntrega}</div>
                <div>${data.ciudadEntrega}, ${data.codigoPostalEntrega}</div>
                <div>${data.provinciaEntrega}, ${data.paisEntrega}</div>
                ${data.observaciones ? `<div style="margin-top:1rem"><strong>Observaciones:</strong> ${data.observaciones}</div>` : ''}
                ${detallesHTML}
            `;

            document.getElementById('pedidoModal').classList.add('show');
        } catch (error) {
            alert('Error al cargar el pedido');
        }
    }

    function closePedidoModal() {
        document.getElementById('pedidoModal').classList.remove('show');
    }

    // ===== CLIENTES =====
    async function loadClientes() {
        const loader = document.getElementById('loader-clientes');
        const table = document.getElementById('table-clientes');
        const tbody = document.getElementById('tbody-clientes');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            const response = await fetchWithAuth(`${API_URL}/clientes?size=100`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';
            data.content.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre || ''} ${item.apellidos || ''}</td>
                    <td>${item.email || ''}</td>
                    <td>${item.telefono || ''}</td>
                    <td>${item.direccion || '-'}</td>
                    <td>${item.ciudad || '-'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewCliente(${item.id})">Ver</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function viewCliente(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/clientes/${id}`);
            const data = await response.json();

            const detalle = document.getElementById('clienteDetalle');
            detalle.innerHTML = `
                <div style="margin-bottom:1rem"><strong>Cliente #${data.id}</strong></div>
                <div style="margin-bottom:.5rem"><strong>Nombre:</strong> ${data.nombre || ''} ${data.apellidos || ''}</div>
                <div style="margin-bottom:.5rem"><strong>Email:</strong> ${data.email || '-'}</div>
                <div style="margin-bottom:.5rem"><strong>Tel√©fono:</strong> ${data.telefono || '-'}</div>
                <hr style="margin:1rem 0">
                <div style="margin-bottom:1rem"><strong>Direcci√≥n:</strong></div>
                <div>${data.direccion || '-'}</div>
                <div>${data.ciudad || '-'}, ${data.codigoPostal || '-'}</div>
                <div>${data.provincia || '-'}, ${data.pais || '-'}</div>
            `;

            document.getElementById('clienteModal').classList.add('show');
        } catch (error) {
            alert('Error al cargar el cliente');
        }
    }

    function closeClienteModal() {
        document.getElementById('clienteModal').classList.remove('show');
    }

    // ===== REPARTIDORES =====
    async function loadRepartidores() {
        const loader = document.getElementById('loader-repartidores');
        const table = document.getElementById('table-repartidores');
        const tbody = document.getElementById('tbody-repartidores');

        loader.style.display = 'block';
        table.classList.add('hidden');

        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores?size=100`);
            const data = await response.json();

            loader.style.display = 'none';
            table.classList.remove('hidden');

            tbody.innerHTML = '';

            let filtered = data.content;
            const activoFilter = document.getElementById('filter-activo').value;
            if (activoFilter) {
                filtered = filtered.filter(r => r.activo.toString() === activoFilter);
            }

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                const esActivo = item.activo === true || item.activo === 1 || item.activo === '1';
                tr.innerHTML = `
                    <td><strong>#${item.id}</strong></td>
                    <td>${item.nombre} ${item.apellidos}</td>
                    <td>${item.email || ''}</td>
                    <td>${item.telefono || ''}</td>
                    <td>${item.matriculaVehiculo || ''}</td>
                    <td><span class="badge ${esActivo ? 'badge-success' : 'badge-danger'}">${esActivo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <div class="actions">
                            <button class="btn ${esActivo ? 'btn-secondary' : 'btn-success'}" onclick="toggleRepartidorEstado(${item.id}, ${!esActivo})">
                                ${esActivo ? 'Desactivar' : 'Activar'}
                            </button>
                            <button class="btn btn-secondary" onclick="editRepartidor(${item.id})">Editar</button>
                            <button class="btn btn-danger" onclick="deleteRepartidor(${item.id})">Eliminar</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function openRepartidorModal(id = null) {
        currentRepartidorId = id;
        document.getElementById('repartidorModalTitle').textContent = id ? 'Editar Repartidor' : 'Nuevo Repartidor';
        document.getElementById('repartidorForm').reset();
        document.getElementById('repartidorAlert').classList.remove('show');

        if (id) loadRepartidorData(id);

        document.getElementById('repartidorModal').classList.add('show');
    }

    function closeRepartidorModal() {
        document.getElementById('repartidorModal').classList.remove('show');
        currentRepartidorId = null;
    }

    async function loadRepartidorData(id) {
        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores/${id}`);
            const data = await response.json();

            document.getElementById('repartidorId').value = data.id;
            document.getElementById('repartidorNombre').value = data.nombre;
            document.getElementById('repartidorApellidos').value = data.apellidos;
            document.getElementById('repartidorEmail').value = data.email;
            document.getElementById('repartidorTelefono').value = data.telefono;
            document.getElementById('repartidorMatricula').value = data.matriculaVehiculo;
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function submitRepartidor(e) {
        e.preventDefault();

        const data = {
            nombre: document.getElementById('repartidorNombre').value,
            apellidos: document.getElementById('repartidorApellidos').value,
            email: document.getElementById('repartidorEmail').value,
            telefono: document.getElementById('repartidorTelefono').value,
            matriculaVehiculo: document.getElementById('repartidorMatricula').value.toUpperCase()
        };

        try {
            const url = currentRepartidorId
                ? `${API_URL}/repartidores/${currentRepartidorId}`
                : `${API_URL}/repartidores`;

            const method = currentRepartidorId ? 'PUT' : 'POST';

            const response = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showAlert('repartidorAlert', 'success', 'Repartidor guardado correctamente');
                setTimeout(() => {
                    closeRepartidorModal();
                    loadRepartidores();
                    loadStats();
                }, 1000);
            } else {
                const error = await response.json();
                showAlert('repartidorAlert', 'error', error.message || 'Error al guardar');
            }
        } catch (error) {
            showAlert('repartidorAlert', 'error', 'Error de conexi√≥n');
        }
    }

    async function editRepartidor(id) {
        openRepartidorModal(id);
    }

    async function deleteRepartidor(id) {
        if (!confirm('¬øEliminar este repartidor?')) return;

        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Repartidor eliminado');
                loadRepartidores();
                loadStats();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al eliminar');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    async function toggleRepartidorEstado(id, nuevoEstado) {
        try {
            const response = await fetchWithAuth(`${API_URL}/repartidores/${id}/estado?activo=${nuevoEstado}`, {
                method: 'PATCH'
            });

            if (response.ok) {
                alert(`Repartidor ${nuevoEstado ? 'activado' : 'desactivado'} correctamente`);
                loadRepartidores();
            } else {
                const error = await response.json();
                alert(error.message || 'Error al cambiar estado');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }

    // UTILIDADES
    function showAlert(id, type, message) {
        const alert = document.getElementById(id);
        alert.className = `alert alert-${type} show`;
        alert.textContent = message;
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }

    // INICIALIZACI√ìN
    checkAuth();
    loadStats();
    loadRestaurantes();
    loadProductoSelects();

</script>

</body>

</html>